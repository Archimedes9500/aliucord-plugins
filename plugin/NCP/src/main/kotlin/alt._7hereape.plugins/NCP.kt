package alt._7hereape.plugins

import com.aliucord.annotations.AliucordPlugin
import com.aliucord.entities.Plugin
import android.annotation.SuppressLint
import android.content.Context
import com.aliucord.patcher.Hook
import com.aliucord.patcher.PreHook
import com.discord.models.user.User
import com.discord.widgets.chat.input.ChatInputViewModel
import com.discord.widgets.chat.input.ChatInputViewModel.ViewState
import com.discord.widgets.chat.MessageManager
import com.discord.widgets.chat.MessageContent
import kotlin.jvm.functions.Function1
import com.discord.api.message.Message
import java.util.regex.Pattern

@AliucordPlugin
class NCP: Plugin(){
	val ver = "nanahira00";
	val key: HashMap<String, Array<Int>> = hashMapOf(
		"nanahira00" to arrayOf(0x4E00),
		"nanahira01" to arrayOf(29987, 32460, 30438, 24784, 27709, 35675, 25829, 25420, 34137, 29330, 23436, 30544, 26896, 35109, 40574, 29401, 32734, 24249, 21257, 36266, 23372, 26745, 27570, 20372, 29703, 39269, 22636, 31313, 28547, 28923, 35883, 30699, 39335, 40903, 27391, 34046, 22363, 27960, 26519, 39700, 21366, 22168, 23628, 20609, 36666, 30565, 30985, 34101, 32885, 25232, 33281, 29911, 22561, 38331, 23585, 40170, 21051, 34929, 27608, 39248, 29842, 28479, 38103, 29671, 33734, 33503, 27639, 32117, 25026, 20432, 38625, 28712, 38830, 40573, 26374, 39879, 30475, 37305, 30706, 38427, 37243, 40288, 36195, 35987, 36390, 22279, 29324, 32711, 38012, 21213, 25371, 20734, 34605, 29989, 20817, 35052, 20496, 21570, 35026, 39660, 23019, 28149, 25316, 23023, 27095, 37846, 30504, 36380, 22527, 34313, 36786, 31442, 34668, 32496, 35773, 39238, 20604, 29588, 27029, 33862, 26412, 39298, 34091, 26275, 30204, 35127, 33223, 36639, 39822, 37833, 26380, 30750, 26267, 40879, 21405, 36680, 34656, 34634, 33887, 23156, 29139, 20142, 38254, 37653, 26313, 35394, 20430, 32058, 36446, 38996, 29469, 38221, 29118, 20451, 25203, 38071, 39372, 24285, 25262, 27007, 29036, 24542, 38986, 29719, 24593, 36706, 35651, 25531, 21878, 31016, 39695, 20326, 32144, 24806, 39266, 35465, 37014, 30114, 25009, 21622, 23044, 34344, 22159, 39398, 26995, 26259, 24637, 24895, 31080, 39608, 29644, 38679, 28155, 32216, 30534, 36662, 37570, 30258, 31061, 29558, 26936, 35562, 29775, 40091, 33604, 27536, 37788, 37114, 36768, 30101, 27026, 37447, 37328, 39298, 30265, 28266, 22206, 25810, 24163, 27932, 35158, 22296, 24571, 30579, 38783, 23026, 30423, 40867, 33258, 36224, 28673, 23593, 37917, 22897, 27176, 32309, 30522, 31391, 29179, 35989, 32225, 24336, 31537, 36856, 33556, 35895, 27740, 27959, 37015, 24607, 32558, 20413, 26827, 33278, 37577, 24939, 20549, 33016, 25549, 34855, 35127, 27150, 35777, 20604, 37185, 38105, 26341, 31892, 34127, 25444, 22931, 27507, 33732, 31867, 22264, 29206, 28985, 30414, 32828, 27205, 27084, 36863, 34390, 23957, 23855, 38601, 37052, 23321, 40511, 40735, 22787, 26678, 27914, 29492, 20553, 34011, 33573, 29541, 30788, 38016, 36226, 28175, 36886, 22965, 21518, 29769, 37683, 36767, 23653, 24301, 27966, 24223, 20837, 37853, 23731, 26729, 26393, 39857, 37975, 38021, 24404, 36117, 30726, 40772, 37070, 38624, 31957, 23760, 38054, 38280, 27109, 30584, 31334, 40818, 31426, 24187, 40239, 35667, 27946, 30932, 26650, 34976, 40697, 24952, 35644, 34230, 34452, 27966, 20173, 33696, 40826, 36260, 38625, 37370, 34687, 39669, 38198, 23994, 32425, 35750, 34017, 37434, 32366, 24668, 19989, 27035, 34701, 22535, 34815, 21074, 40555, 37304, 20347, 27640, 20952, 28486, 19972, 36810, 32035, 34452, 30821, 25985, 30927, 39972, 34609, 25446, 22135, 36927, 34485, 29555, 40413, 39162, 29409, 38074, 23238, 24528, 26347, 31626, 29189, 31853, 35129, 32988, 20512, 29667, 32681, 25716, 26591, 40708, 20826, 37445, 38000, 30001, 25782, 32039, 29796, 30219, 31688, 34135, 38752, 27694, 37950, 33970, 28503, 40883, 40756, 26223, 29600, 29425, 23104, 29751, 20283, 30741, 36468, 29138, 30272, 21784, 31214, 20522, 28153, 22396, 38116, 31928, 34793, 19994, 40344, 37278, 22491, 36367, 25187, 23415, 32547, 39670, 30295, 39263, 20324, 25170, 25018, 22834, 31993, 38009, 38784, 31570, 22968, 38451, 35609, 28421, 28280, 39598, 36538, 31427, 33829, 30476, 35901, 36010, 22248, 23654, 23793, 20467, 31694, 28487, 25938, 27660, 21095, 23575, 35364, 31598, 34408, 21916, 31111, 35781, 35558, 26719, 22601, 21317, 35859, 30606, 23147, 25516, 38564, 29153, 33386, 25525, 40837, 22973, 29220, 26673, 27323, 28576, 20309, 25977, 26061, 21098, 23039, 32424, 36753, 23795, 38196, 38766, 33828, 23233, 36063, 28652, 28365, 29482, 29872, 34506, 36279, 40057, 37363, 22004, 32083, 39149, 25342, 27982, 29967, 20335, 28979, 39626, 25554, 33942, 22981, 35298, 32562, 40208, 38346, 27774, 27335, 35972, 34119, 37525, 35114, 21550, 33967, 25145, 28793, 33513, 26944, 27443, 34166, 33621, 39269, 23841, 26990, 31057, 23686, 38396, 21947, 37641, 20852, 34147, 37043, 23987, 28861, 35622, 40620, 26556, 40285, 20826, 20394, 33318, 33119, 35001, 20830, 38198, 32786, 33264, 39054, 20512, 32214, 25439, 40169, 20348, 20359, 39419, 24557, 25064, 32651, 21033, 28420, 36924, 31536, 35638, 20244, 39940, 24366, 28678, 22664, 31805, 38131, 28995, 36788, 38731, 33994, 28086, 22113, 31422, 23797, 33570, 20611, 39583, 36127, 32007, 32406, 29025, 30176, 20747, 31517, 27714, 25080, 24578, 28941, 30366, 22625, 38505, 40371, 37570, 24945, 35527, 28044, 34262, 21806, 21765, 40096, 35586, 36860, 35060, 25873, 25612, 40909, 32164, 35699, 21467, 33706, 23351, 23665, 25184, 22178, 34488, 22205, 37143, 31710, 21663, 30085, 22173, 31330, 30500, 24189, 23782, 30772, 35471, 26152, 34393, 24530, 27657, 39692, 26722, 28795, 24783, 33785, 20967, 27287, 24221, 23440, 25135, 30219, 25314, 39159, 32923, 24252, 36232, 38137, 23275, 33398, 32833, 36202, 30964, 25131, 24205, 39769, 24229, 39787, 24893, 38623, 37875, 30340, 36982, 28910, 35494, 30492, 39190, 27421, 23869, 23128, 40628, 33611, 23248, 30596, 20609, 29737, 20008, 27473, 32516, 30728, 25617, 34397, 33409, 32506, 38574, 38136, 38158, 35804, 21555, 25719, 30190, 21684, 36144, 38237, 21975, 31869, 32786, 33455, 37056, 22220, 27409, 20347, 30022, 28976, 24140, 21422, 25643, 31487, 21531, 40851, 29090, 20608, 22026, 35315, 24568, 31452, 37275, 34528, 26059, 29675, 33472, 40386, 33115, 22848, 22578, 38582, 28693, 29595, 36900, 23091, 36816, 39608, 39936, 34655, 37933, 35167, 39475, 37805, 37651, 35653, 28541, 29710, 22718, 22414, 35986, 40788, 34246, 28952, 36329, 38646, 20247, 25362, 35591, 40144, 32418, 24769, 21175, 31385, 21947, 26201, 25791, 27865, 37458, 37123, 39679, 37473, 23059, 29993, 29434, 21458, 20279, 29430, 37050, 26923, 20908, 20766, 33416, 36828, 23185, 27489, 30039, 40039, 39477, 22992, 27448, 39701, 32394, 33237, 36896, 30276, 25830, 26620, 32055, 23740, 34504, 28955, 33539, 35055, 23735, 33660, 28937, 25208, 32767, 40825, 33512, 35027, 40369, 22424, 22426, 40685, 24773, 35178, 30857, 32489, 27532, 28516, 20394, 29128, 34702, 33962, 20528, 21492, 33838, 37578, 36608, 27865, 32567, 36767, 28982, 21515, 23097, 31325, 39176, 40834, 27864, 23308, 29066, 40023, 27697, 35981, 34969, 24952, 39055, 27880, 38795, 29949, 38965, 33745, 24977, 34424, 35864, 29060, 33734, 28511, 23331, 38583, 28546, 30808, 25201, 28025, 38119, 27584, 24282, 36808, 40037, 26120, 34706, 38919, 22152, 22369, 34380, 32054, 39134, 31624, 23827, 28991, 21080, 36632, 22856, 23991, 38213, 27335, 25662, 20020, 28806, 39327, 26170, 40790, 37896, 38723, 31546, 22387, 38870, 36765, 26803, 19968, 38037, 38319, 28583, 32585, 25375, 21374, 33466, 34227, 35904, 29855, 29966, 22133, 38385, 35704, 37773, 40062, 24310, 26331, 27493, 28645, 20894, 33766, 37032, 20490, 27196, 37143, 39314, 35999, 26669, 27985, 34775, 37388, 30015, 34267, 30641, 35485, 36094, 23767, 30836, 40816, 40826, 38240, 20820, 20088, 24411, 36110, 24232, 37071, 26780, 23694, 36010, 38213, 33140, 31568, 38032, 24370, 30162, 37514, 21558, 39750, 35103, 20079, 37928, 39995, 27674, 30007, 29088, 34848, 34827, 31463, 28268, 32979, 34477, 36100, 39152, 30102, 36451, 35198, 26619, 36703, 37432, 26273, 27188, 34255, 29085, 28570, 25394, 28488, 27064, 27021, 32541, 33563, 27626, 21126, 26890, 28340, 36078, 31651, 35381, 22100, 40801, 39928, 35933, 27238, 30144, 33203, 38078, 22846, 34993, 26227, 39965, 36923, 28787, 39151, 35144, 32463, 38644, 33650, 35009, 40219, 38070, 37935, 32870, 32955, 40386, 29683, 25094, 26320, 21476, 26006, 37587, 26265, 36484, 30865, 29863, 24938, 29063, 35970, 38573, 34446, 33137, 23863, 34090, 28637, 26844, 37094, 34593, 39911, 40789, 30092, 26421, 30608, 27896, 40235, 35270, 40320, 27853, 23083, 27233, 32499, 21242, 22333, 24153, 37076, 21855, 21847, 25426, 40411, 25031, 27073, 26842, 31092, 21451, 28586, 25564, 33939, 34641, 22891, 33930, 22211, 40558, 31470, 27995, 38664, 20740, 29473, 26963, 30127, 20349, 20379, 40316, 39769, 37643, 29844, 24442, 29090, 31288, 31011, 27184, 37010, 34280, 20529, 21746, 40803, 30406, 39771, 24896, 25196, 30936, 24767, 35703, 31064, 35729, 37091, 35122, 27875, 24762, 29440, 39654, 29868, 31210, 20993, 20469, 35108, 20135, 29646, 25668, 30331, 24306, 21309, 23922, 30633, 28920, 25919, 39789, 30270, 32263, 24017, 31719, 28670, 37723, 22205, 20980, 21210, 36975, 31192, 37861, 29083, 34674, 28559, 23840, 20986, 28056, 29336, 26332, 38285, 32684, 31493, 35166, 26729, 25393, 36408, 28609, 27901, 37688, 36965, 20739, 36842, 39839, 26285, 28078, 39235, 36466, 22098, 37469, 23496, 23174, 37729, 35544, 35623, 20262, 20344, 24769, 27120, 27406, 34169, 29410, 23426, 22552, 24118, 38033, 26893, 37247, 33676, 35472, 35504, 24453, 26156, 28386, 32797, 21141, 27636, 27410, 22419, 21461, 20329, 30882, 23712, 35602, 20920, 32325, 20130, 23763, 37896, 24880, 23295, 34027, 33957, 38048, 38376, 29581, 22814, 38083, 32922, 22450, 40882, 22118, 31682, 35317, 21725, 36952, 35630, 23055, 23039, 39913, 25032, 39885, 21487, 22167, 31080, 21066, 27619, 30441, 26951, 37152, 29416, 32993, 29999, 27328, 31969, 40632, 28796, 21500, 20138, 21771, 33510, 37315, 27778, 34049, 31900, 39127, 23628, 33469, 35609, 27549, 21761, 32962, 37344, 37651, 29968, 38138, 23757, 35569, 28387, 31357, 35843, 24280, 31452, 36264, 35398, 23005, 31524, 40069, 20937, 32911, 35065, 30605, 36793, 27186, 28657, 30701, 32879, 36996, 24196, 28074, 24946, 38849, 22897, 23277, 29555, 30444, 26490, 25406, 37857, 37494, 21620, 23394, 38132, 32623, 38070, 24713, 38806, 38205, 21089, 33624, 30536, 38291, 30886, 20909, 34447, 26379, 34701, 38168, 21362, 35908, 21334, 37993, 38002, 37232, 26871, 22177, 24538, 32873, 21655, 35698, 40372, 36849, 24853, 40477, 25919, 35936, 22574, 25440, 26303, 32079, 27508, 29951, 27901, 22234, 24542, 26799, 32781, 24605, 35009, 35389, 31362, 28300, 32711, 39234, 24050, 33262, 26884, 34576, 26623, 20705, 23978, 33897, 29433, 30243, 35520, 40263, 24001, 26034, 20472, 39882, 38121, 25254, 38090, 21250, 23032, 28545, 24935, 22391, 31360, 30686, 28975, 32184, 40656, 33985, 24178, 37864, 29759, 35830, 26883, 22351, 37320, 33070, 21578, 36498, 31999, 29995, 23527, 26796, 33003, 29948, 20033, 26390, 21476, 27262, 31702, 24441, 36412, 27315, 34376, 30542, 28658, 35012, 39711, 23759, 37897, 27535, 32835, 20977, 39597, 29986, 35353, 25327, 29313, 35502, 22385, 31327, 31488, 24443, 37712, 31662, 22342, 21672, 39584, 37564, 30405, 36540, 34400, 40653, 24217, 29321, 25318, 26262, 26652, 34099, 24256, 39481, 21935, 20843, 35752, 36016, 20989, 37212, 27034, 20198, 35881, 20314, 21739, 29997, 37751, 22938, 37154, 32971, 31264, 27815, 40871, 28806, 23060, 28253, 23452, 38047, 20595, 21548, 29123, 40534, 21625, 34807, 25885, 23662, 30195, 30300, 35060, 30476, 37979, 28450, 34658, 29592, 25087, 32638, 38864, 26262, 35755, 23156, 31852, 24231, 31003, 37159, 39712, 39990, 29935, 35686, 20030, 24191, 38529, 29915, 39602, 20807, 37994, 30788, 36567, 26039, 29474, 36973, 28105, 25690, 40770, 22691, 21084, 27971, 31471, 39321, 27988, 28298, 24172, 31538, 20033, 22903, 31106, 20998, 24469, 38514, 35449, 23053, 26933, 34093, 21117, 28159, 25378, 37651, 36715, 25050, 36151, 21465, 38128, 34582, 36040, 29267, 26243, 36552, 30491, 21856, 37600, 38447, 40530, 20493, 35228, 27284, 26385, 29641, 35838, 35999, 26468, 32839, 21719, 36903, 27981, 34919, 29803, 26107, 29474, 29540, 27561, 38251, 21108, 39189, 33744, 39838, 34609, 39482, 39938, 40430, 24713, 23874, 34968, 31175, 31952, 30707, 24883, 23189, 32290, 40521, 32976, 24393, 34302, 34685, 38364, 22792, 34717, 38755, 27889, 39586, 22757, 34182, 27065, 28942, 40710, 26330, 37943, 37677, 30100, 24197, 22466, 35095, 23970, 35328, 27119, 37146, 40169, 35439, 22315, 25194, 31833, 35777, 29564, 23567, 31649, 29403, 33973, 33767, 39643, 28333, 40109, 25209, 31251, 27015, 34044, 33857, 35935, 39905, 37824, 23228, 20191, 32234, 25789, 37686, 27650, 37238, 39506, 40728, 38577, 37362, 38681, 36823, 26815, 22392, 40678, 37688, 22758, 33104, 34844, 38698, 32735, 21395, 31448, 26220, 30774, 38368, 22972, 22726, 20482, 26245, 30964, 26570, 23498, 38251, 35932, 34011, 26207, 36956, 35311, 20086, 34288, 35429, 23131, 38031, 39443, 23309, 25714, 28856, 32522, 29876, 27438, 29734, 35338, 29952, 27665, 27966, 40483, 39434, 26282, 27094, 40836, 33315, 32102, 25288, 31623, 34531, 25434, 29973, 33537, 32454, 23375, 22790, 26583, 25454, 37199, 34865, 34177, 26392, 23281, 25367, 27117, 27961, 34683, 33150, 21988, 32138, 26135, 27304, 39754, 34142, 23061, 35848, 39076, 20516, 27373, 21141, 39453, 39641, 24582, 40460, 34605, 35441, 34893, 25902, 38396, 22952, 20443, 26697, 40762, 29890, 35576, 20423, 25289, 30898, 33731, 34999, 39849, 34524, 29055, 26262, 39261, 37369, 26002, 38322, 20791, 39250, 22671, 26663, 28138, 24856, 26402, 20051, 38777, 30113, 29784, 32212, 36169, 33809, 29634, 35929, 28231, 40774, 25506, 37418, 36950, 31397, 38786, 32220, 23230, 33882, 24304, 21501, 30570, 32708, 31493, 34976, 35862, 36799, 26757, 26100, 28326, 29269, 40671, 21643, 23957, 25229, 37751, 40124, 32672, 31194, 38073, 40294, 29093, 30290, 33024, 40369, 22370, 28888, 33465, 27898, 39528, 24466, 38242, 38803, 23661, 25588, 29743, 35014, 20801, 27637, 28534, 26623, 40043, 23833, 40023, 37720, 39020, 24312, 20088, 25067, 34596, 21718, 39227, 31350, 36975, 35481, 32436, 31429, 32639, 34435, 31975, 31036, 33681, 31368, 23370, 23978, 39957, 20672, 38552, 25326, 29825, 32150, 40599, 39732, 33371, 26666, 22891, 34893, 26994, 38819, 40647, 29707, 35912, 30105, 28166, 31231, 21287, 25878, 29281, 24773, 31927, 28058, 22658, 40430, 35677, 22841, 26572, 29539, 37735, 21619, 26733, 26293, 40024, 23740, 39055, 24267, 27762, 36673, 23889, 29892, 27509, 31526, 22652, 20425, 23808, 40206, 34556, 26460, 22879, 21394, 26960, 38123, 31956, 31022, 32117, 39630, 36265, 33104, 30703, 36078, 28384, 30152, 29131, 21295, 33982, 35079, 30077, 28775, 21997, 29131, 39531, 33237, 38834, 31152, 20625, 37631, 32457, 30393, 25973, 37833, 33811, 32948, 26211, 29916, 26792, 33180, 22672, 28454, 39686, 31487, 37181, 40880, 20412, 20163, 34114, 27686)
	);
	val meta: HashMap<String, HashMap<String, Int>> = hashMapOf(
		"nanahira00" to hashMapOf(
			"min" to  0x4E00,
			"max" to 0x9FFF,
			"limit" to 0xFFFD,
			"length" to 1
		),
		"nanahira01" to hashMapOf(
			"min" to  0x4E00,
			"max" to 0x9FFF,
			"limit" to 0xFFFD,
			"length" to 2000
		)
	);
	fun mod(x: Int, y: Int): Int{
		return ((x%y)+y)%y;
	};
	fun Int.wrap(ver: String): Int{
		val m = meta[ver]!!;
		return mod((this-m["min"]!!), (m["limit"]!!-m["min"]!!+1))+m["min"]!!;
	};
	fun encrypt(string: String): String{
		val r = Pattern.compile("""<.*?>|[\[\]\(\)*~#-_>\n]""");
		val matcher = r.matcher(string);

		var out = StringBuilder(string);
		var flag = matcher.find(0);
		if(key[ver] != null){
			for(i in out.indices){
				if(flag){
					val m = matcher.toMatchResult();
					if(i >= m.start() && i < m.end()) continue;
					if(i == m.end()) flag = matcher.find(i);
				};
				val c = out[i]!!.toInt();
				val l = meta[ver]!!.get("length")!!;
				val k = key[ver]!!.get(i%l)!!;
				out[i] = (c+k).wrap(ver).toChar()!!;
			};
		}else{
			return string;
		};
		return ver+out.toString();
	};
	fun decrypt(string: String): String{
		val r = Pattern.compile("""<.*?>|[\[\]\(\)*~#-_>\n]""");
		val matcher = r.matcher(string.substring(10));

		var out = StringBuilder(string.substring(10));
		val ver = string.substring(0, 10);
		var flag = matcher.find(0);
		if(key[ver] != null){
			for(i in out.indices){
				if(flag){
					val m = matcher.toMatchResult();
					if(i >= m.start() && i < m.end()) continue;
					if(i == m.end()) flag = matcher.find(i);
				};
				val c = out[i]!!.toInt();
				val l = meta[ver]!!.get("length")!!;
				val k = key[ver]!!.get(i%l)!!;
				out[i] = (c-k).wrap(ver).toChar()!!;
			};
		}else{
			return string;
		};
		return out.toString();
	};

	override fun start(pluginContext: Context){
		patcher.patch(
			ChatInputViewModel::class.java.getDeclaredMethod(
				"sendMessage",
				Context::class.java,
				MessageManager::class.java,
				MessageContent::class.java,
				List::class.java,
				Boolean::class.javaPrimitiveType,
				Function1::class.java
			),
			PreHook{frame ->
				val (text: String, users: List<User>) = frame.args[2] as MessageContent;
				if(text.substring(0, 10) != "nanahirape") return@PreHook;
				frame.args[2] = MessageContent(encrypt(text.substring(10)), users);
			}
		);
		patcher.patch(
			Message::class.java.getDeclaredMethod("i"),
			Hook{frame ->
				if(frame.result == null) return@Hook;
				val text = frame.result as String;
				if(text.length < 10) return@Hook;
				frame.result = decrypt(text);
			}
		);
	};

	override fun stop(pluginContext: Context){
		patcher.unpatchAll();
	};
};